<div class="mb-4">
  <!-- Header & Navigation -->
  <div class="d-flex justify-content-center align-items-center mb-4">
    <div class="d-flex align-items-center">
      <% if @prev_year_valid %>
        <%= link_to root_path(year: @selected_year - 1), id: 'prev-year-link', class: 'btn btn-outline-secondary me-3' do %>
          <i class="bi bi-chevron-left"></i>
        <% end %>
      <% else %>
        <button class="btn btn-outline-secondary me-3" disabled id="prev-year-disabled" onclick="triggerShake()"><i class="bi bi-chevron-left"></i></button>
      <% end %>
      
      <h3 class="m-0" style="min-width: 150px; text-align: center; display: inline-block;"><%= @selected_year %></h3>
      
      <% if @next_year_valid %>
        <%= link_to root_path(year: @selected_year + 1), id: 'next-year-link', class: 'btn btn-outline-secondary ms-3' do %>
          <i class="bi bi-chevron-right"></i>
        <% end %>
      <% else %>
        <button class="btn btn-outline-secondary ms-3" disabled id="next-year-disabled" onclick="triggerShake()"><i class="bi bi-chevron-right"></i></button>
      <% end %>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="row mb-4">


    <div class="col-xl-4 mb-4 mb-xl-0">
      <div class="card h-100" data-controller="chart-switcher">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title m-0" data-chart-switcher-target="title">Yearly Overview</h5>
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-secondary active" 
                    data-chart-switcher-target="btn" 
                    data-action="click->chart-switcher#switch" 
                    data-view-name="overview" 
                    data-title="Yearly Overview"
                    data-bs-toggle="tooltip" 
                    title="Overview">
              <i class="bi bi-pie-chart-fill"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" 
                    data-chart-switcher-target="btn" 
                    data-action="click->chart-switcher#switch" 
                    data-view-name="income" 
                    data-title="Income By Category"
                    data-bs-toggle="tooltip" 
                    title="Income Breakdown">
              <i class="bi bi-wallet2"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" 
                    data-chart-switcher-target="btn" 
                    data-action="click->chart-switcher#switch" 
                    data-view-name="expenses" 
                    data-title="Expenses By Category"
                    data-bs-toggle="tooltip" 
                    title="Expenses Breakdown">
              <i class="bi bi-cart4"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" 
                    data-chart-switcher-target="btn" 
                    data-action="click->chart-switcher#switch" 
                    data-view-name="savings" 
                    data-title="Savings By Category"
                    data-bs-toggle="tooltip" 
                    title="Savings Breakdown">
              <i class="bi bi-piggy-bank-fill"></i>
            </button>
          </div>
        </div>
        <div class="card-body" style="height: 300px;">
          <!-- Overview Chart -->
          <div data-chart-switcher-target="view" data-view-name="overview" style="position: relative; height: 100%; width: 100%;">
            <canvas
              data-controller="charts"
              data-charts-type-value="doughnut"
              data-charts-data-value="<%= @overview_chart_data.to_json %>"
              data-charts-center-label-value="Net Total"
              data-charts-center-text-value="<%= number_to_currency(@yearly_net_total) %>"
              data-charts-center-color-value="<%= @yearly_net_total >= 0 ? '#198754' : '#dc3545' %>"
              data-charts-options-value="<%= {
                plugins: { legend: { position: 'bottom' } },
                maintainAspectRatio: false,
                cutout: '80%'
              }.to_json %>"
            ></canvas>
          </div>
          
          <!-- Income Chart -->
          <div data-chart-switcher-target="view" data-view-name="income" class="d-none" style="height: 100%; width: 100%;">
             <canvas
              data-controller="charts"
              data-charts-type-value="bar"
              data-charts-data-value="<%= @income_by_category_data.to_json %>"
              data-charts-options-value="<%= {
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                maintainAspectRatio: false,
                scales: { x: { beginAtZero: true } }
              }.to_json %>"
            ></canvas>
          </div>

          <!-- Expenses Chart -->
          <div data-chart-switcher-target="view" data-view-name="expenses" class="d-none" style="height: 100%; width: 100%;">
             <canvas
              data-controller="charts"
              data-charts-type-value="bar"
              data-charts-data-value="<%= @expenses_by_category_data.to_json %>"
              data-charts-options-value="<%= {
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                maintainAspectRatio: false,
                scales: { x: { beginAtZero: true } }
              }.to_json %>"
            ></canvas>
          </div>

          <!-- Savings Chart -->
          <div data-chart-switcher-target="view" data-view-name="savings" class="d-none" style="height: 100%; width: 100%;">
             <canvas
              data-controller="charts"
              data-charts-type-value="bar"
              data-charts-data-value="<%= @savings_by_category_data.to_json %>"
              data-charts-options-value="<%= {
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                maintainAspectRatio: false,
                scales: { x: { beginAtZero: true } }
              }.to_json %>"
            ></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-8">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="card-title m-0">Monthly Breakdown</h5>
        </div>
        <div class="card-body" style="height: 300px;">
          <canvas
            data-controller="charts"
            data-charts-type-value="line"
            data-charts-data-value="<%= @monthly_breakdown_data.to_json %>"
            data-charts-options-value="<%= {
              responsive: true,
              maintainAspectRatio: false,
              scales: { y: { beginAtZero: true } },
              interaction: {
                mode: 'index',
                intersect: false,
              },
              plugins: {
                tooltip: {
                  enabled: true
                }
              }
            }.to_json %>"
          ></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-header">
      <h5 class="card-title m-0">Yearly Category Breakdown</h5>
    </div>
    <div class="card-body p-0">
      <div class="horizontal-scroll">
        <table class="table table-bordered table-hover align-middle mb-0">
      <thead>
        <tr>
          <th>
            <div class="d-flex justify-content-between align-items-center">
              <span>Category</span>
              <div class="dropdown">
                <button class="btn btn-link p-0" type="button" id="categoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-plus header-icon"></i>
                </button>
                <ul class="dropdown-menu" aria-labelledby="categoryDropdown">
                  <li><%= link_to 'Add Category', new_category_path, class: 'dropdown-item' %></li>
                </ul>
              </div>
            </div>
          </th>
          <th class="bg-light">
            <div class="d-flex justify-content-between align-items-center">
              <span>Budget Amount</span>
              <div class="dropdown">
                <button class="btn btn-link p-0" type="button" id="budgetDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-plus header-icon"></i>
                </button>
                <ul class="dropdown-menu" aria-labelledby="budgetDropdown">
                  <li><%= link_to 'Add Budget Item', new_budget_path(year: @selected_year), class: 'dropdown-item' %></li>
                </ul>
              </div>
            </div>
          </th>
          <% (1..12).each do |month| %>
            <th>
              <div class="d-flex justify-content-between align-items-center">
                <span><%= Date::MONTHNAMES[month] %></span>
                <div class="dropdown">
                  <button class="btn btn-link p-0" type="button" id="monthDropdown<%= month %>" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-plus header-icon"></i>
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="monthDropdown<%= month %>">
                    <li><%= link_to 'Add Transaction', new_transaction_path(date: Date.new(@selected_year.to_i, month, 1)), class: 'dropdown-item' %></li>
                  </ul>
                </div>
              </div>
            </th>
          <% end %>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        <!-- Income -->
        <tr class="table-light no-hover-highlight">
          <td colspan="15" class="fw-bold text-uppercase text-muted ps-3">Income</td>
        </tr>
        <!-- Income Rows -->
        <% @category_data.each do |category_id, category_hash| %>
          <% next unless category_hash[:category_type] == "income" %>
          <!-- Top-Level Category -->
          <tr>
            <td>
              <% if category_hash[:subcategories].any? %>
                <i class="bi bi-chevron-right toggle-subcategories" data-controller="toggle" data-action="click->toggle#toggle" data-category-id="<%= category_hash[:category].id %>"></i>
              <% else %>
                <i class="bi bi-dot"></i>
              <% end %>
              <%= category_hash[:category].name %>
            </td>
            <td class="bg-light"><%= number_to_currency(category_hash[:budgeted_amount] / 100.0) %></td>
            <% (1..12).each do |month| %>
              <% actual = category_hash[:monthly_transactions][month] %>
              <% budget_data = category_hash[:monthly_budgets][month] %>
              <% budgeted = budget_data[:amount] %>
              <% override_class = budget_data[:is_override] ? 'bg-budget-override' : '' %>
              <td class="<%= income_status_class(actual, budgeted) %> <%= override_class %>">
                <%= number_to_currency(actual / 100.0) %>
              </td>
            <% end %>
            <% actual_total = category_hash[:total_transactions] %>
            <% budgeted_total = category_hash[:budgeted_amount] * 12 %>
            <td class="<%= income_status_class(actual_total, budgeted_total) %>">
              <%= number_to_currency(actual_total / 100.0) %>
            </td>
          </tr>

          <!-- Subcategory Rows -->
          <% category_hash[:subcategories].each do |sub_hash| %>
            <tr class="subcategory-row hidden-row" data-parent-id="<%= category_hash[:category].id %>">
              <td class="pl-4 text-muted">
                <i class="bi bi-arrow-return-right me-2"></i> <%= sub_hash[:category].name %>
              </td>
              <td class="bg-light"><%= number_to_currency(sub_hash[:budgeted_amount] / 100.0) %></td>
              <% (1..12).each do |month| %>
                <% actual = sub_hash[:monthly_transactions][month] %>
                <% budget_data = sub_hash[:monthly_budgets][month] %>
                <% budgeted = budget_data[:amount] %>
                <% override_class = budget_data[:is_override] ? 'bg-budget-override' : '' %>
                <td class="<%= income_status_class(actual, budgeted) %> <%= override_class %>">
                  <%= number_to_currency(actual / 100.0) %>
                </td>
              <% end %>
              <% actual_total = sub_hash[:total_transactions] %>
              <% budgeted_total = sub_hash[:budgeted_amount] * 12 %>
              <td class="<%= income_status_class(actual_total, budgeted_total) %>">
                <%= number_to_currency(actual_total / 100.0) %>
              </td>
            </tr>
          <% end %>
        <% end %>

        <!-- Expenses -->
        <tr class="table-light no-hover-highlight">
          <td colspan="15" class="fw-bold text-uppercase text-muted ps-3">Expenses</td>
        </tr>
        <!-- Expense Rows -->
        <% @category_data.each do |category_id, category_hash| %>
          <% next unless category_hash[:category_type] == "expense" %>
          <!-- Top-Level Category -->
          <tr>
            <td>
              <% if category_hash[:subcategories].any? %>
                <i class="bi bi-chevron-right toggle-subcategories" data-controller="toggle" data-action="click->toggle#toggle" data-category-id="<%= category_hash[:category].id %>"></i>
              <% else %>
                <i class="bi bi-dot"></i>
              <% end %>
              <%= category_hash[:category].name %>
            </td>
            <td class="bg-light"><%= number_to_currency(category_hash[:budgeted_amount] / 100.0) %></td>
            <% (1..12).each do |month| %>
              <% actual = category_hash[:monthly_transactions][month] %>
              <% budget_data = category_hash[:monthly_budgets][month] %>
              <% budgeted = budget_data[:amount] %>
              <% override_class = budget_data[:is_override] ? 'bg-budget-override' : '' %>
              <td class="<%= expense_status_class(actual, budgeted) %> <%= override_class %>">
                <%= number_to_currency(actual / 100.0) %>
              </td>
            <% end %>
            <% actual_total = category_hash[:total_transactions] %>
            <% budgeted_total = category_hash[:budgeted_amount] * 12 %>
            <td class="<%= expense_status_class(actual_total, budgeted_total) %>">
              <%= number_to_currency(actual_total / 100.0) %>
            </td>
          </tr>

          <!-- Subcategory Rows -->
          <% category_hash[:subcategories].each do |sub_hash| %>
            <tr class="subcategory-row hidden-row" data-parent-id="<%= category_hash[:category].id %>">
              <td class="pl-4 text-muted">
                <i class="bi bi-arrow-return-right me-2"></i> <%= sub_hash[:category].name %>
              </td>
              <td class="bg-light"><%= number_to_currency(sub_hash[:budgeted_amount] / 100.0) %></td>
              <% (1..12).each do |month| %>
                <% actual = sub_hash[:monthly_transactions][month] %>
                <% budget_data = sub_hash[:monthly_budgets][month] %>
                <% budgeted = budget_data[:amount] %>
                <% override_class = budget_data[:is_override] ? 'bg-budget-override' : '' %>
                <td class="<%= expense_status_class(actual, budgeted) %> <%= override_class %>">
                  <%= number_to_currency(actual / 100.0) %>
                </td>
              <% end %>
              <% actual_total = sub_hash[:total_transactions] %>
              <% budgeted_total = sub_hash[:budgeted_amount] %>
              <td class="<%= expense_status_class(actual_total, budgeted_total) %>">
                <%= number_to_currency(actual_total / 100.0) %>
              </td>
            </tr>
          <% end %>
        <% end %>
        <!-- Savings -->
        <tr class="table-light no-hover-highlight">
          <td colspan="15" class="fw-bold text-uppercase text-muted ps-3">Savings</td>
        </tr>
        <!-- Savings Rows -->
        <% @category_data.each do |category_id, category_hash| %>
          <% next unless category_hash[:category_type] == "savings" %>
          <!-- Top-Level Category -->
          <tr>
            <td>
              <% if category_hash[:subcategories].any? %>
                <i class="bi bi-chevron-right toggle-subcategories" data-controller="toggle" data-action="click->toggle#toggle" data-category-id="<%= category_hash[:category].id %>"></i>
              <% else %>
                <i class="bi bi-dot"></i>
              <% end %>
              <%= category_hash[:category].name %>
            </td>
            <td class="bg-light"><%= number_to_currency(category_hash[:budgeted_amount] / 100.0) %></td>
            <% (1..12).each do |month| %>
              <% actual = category_hash[:monthly_transactions][month] %>
              <% budget_data = category_hash[:monthly_budgets][month] %>
              <% budgeted = budget_data[:amount] %>
              <% override_class = budget_data[:is_override] ? 'bg-budget-override' : '' %>
              <td class="<%= income_status_class(actual, budgeted) %> <%= override_class %>">
                <%= number_to_currency(actual / 100.0) %>
              </td>
            <% end %>
            <% actual_total = category_hash[:total_transactions] %>
            <% budgeted_total = category_hash[:budgeted_amount] * 12 %>
            <td class="<%= income_status_class(actual_total, budgeted_total) %>">
              <%= number_to_currency(actual_total / 100.0) %>
            </td>
          </tr>

          <!-- Subcategory Rows -->
          <% category_hash[:subcategories].each do |sub_hash| %>
            <tr class="subcategory-row hidden-row" data-parent-id="<%= category_hash[:category].id %>">
              <td class="pl-4 text-muted">
                <i class="bi bi-arrow-return-right me-2"></i> <%= sub_hash[:category].name %>
              </td>
              <td class="bg-light"><%= number_to_currency(sub_hash[:budgeted_amount] / 100.0) %></td>
              <% (1..12).each do |month| %>
                <% actual = sub_hash[:monthly_transactions][month] %>
                <% budget_data = sub_hash[:monthly_budgets][month] %>
                <% budgeted = budget_data[:amount] %>
                <% override_class = budget_data[:is_override] ? 'bg-budget-override' : '' %>
                <td class="<%= income_status_class(actual, budgeted) %> <%= override_class %>">
                  <%= number_to_currency(actual / 100.0) %>
                </td>
              <% end %>
              <% actual_total = sub_hash[:total_transactions] %>
              <% budgeted_total = sub_hash[:budgeted_amount] * 12 %>
              <td class="<%= income_status_class(actual_total, budgeted_total) %>">
                <%= number_to_currency(actual_total / 100.0) %>
              </td>
            </tr>
          <% end %>
        <% end %>

      </tbody>
      <tfoot class="table-group-divider">
      <!-- Total Income -->
        <tr>
          <td><strong>Total Income</strong></td>
          <td class="bg-light">
            <%= number_to_currency(@budgeted_income_total / 100.0) %>
          </td>
          <% (1..12).each do |month| %>
            <td class="<%= income_status_class(@monthly_income_totals[month], @budgeted_income_total) %>">
              <%= number_to_currency(@monthly_income_totals[month] / 100.0) %>
            </td>
          <% end %>
          <td class="<%= income_status_class(@monthly_income_totals.values.sum, @budgeted_income_total) %>">
            <%= number_to_currency(@monthly_income_totals.values.sum / 100.0) %>
          </td>
        </tr>
        <!-- Total Expenses -->
        <tr>
          <td><strong>Total Expenses</strong></td>
          <td class="bg-light">
            <%= number_to_currency(@budgeted_expense_total / 100.0) %>
          </td>
          <% (1..12).each do |month| %>
            <td class="<%= expense_status_class(@monthly_expense_totals[month], @budgeted_expense_total) %>">
              <%= number_to_currency(@monthly_expense_totals[month] / 100.0) %>
            </td>
          <% end %>
          <td class="<%= expense_status_class(@monthly_expense_totals.values.sum, @budgeted_expense_total) %>">
            <%= number_to_currency(@monthly_expense_totals.values.sum / 100.0) %>
          </td>
        </tr>
        <!-- Net Total -->
        <tr>
          <td><strong>Net Total</strong></td>
          <td class="bg-light"><%= number_to_currency(@budgeted_net_total / 100.0) %></td>
          <% (1..12).each do |month| %>
            <% net_monthly_total = @monthly_income_totals[month] - @monthly_expense_totals[month] %>
            <td class="<%= income_status_class(net_monthly_total, @budgeted_net_total) %>">
              <%= number_to_currency(net_monthly_total / 100.0).gsub('-', '&#8209;').html_safe %>
            </td>
          <% end %>
          <% net_total = @monthly_income_totals.values.sum - @monthly_expense_totals.values.sum %>
          <td class="<%= income_status_class(net_total, @budgeted_net_total) %>">
            <%= number_to_currency(net_total / 100.0).gsub('-', '&#8209;').html_safe %>
          </td>
        </tr>
        <!-- Total Savings -->
        <tr>
          <td><strong>Total Savings</strong></td>
          <td class="bg-light">
            <%= number_to_currency(@budgeted_savings_total / 100.0) %>
          </td>
          <% (1..12).each do |month| %>
            <td class="<%= income_status_class(@monthly_savings_totals[month], @budgeted_savings_total) %>">
              <%= number_to_currency(@monthly_savings_totals[month] / 100.0) %>
            </td>
          <% end %>
          <td class="<%= income_status_class(@monthly_savings_totals.values.sum, @budgeted_savings_total) %>">
            <%= number_to_currency(@monthly_savings_totals.values.sum / 100.0) %>
          </td>
        </tr>
      </tfoot>
    </table>
  </div>
  </div>
  </div>

    <%= render 'loans/index', loans: @loans, active_loans: @active_loans, paid_off_loans: @paid_off_loans, dashboard: true %>
    <%= render 'goals/index', goals: @goals, dashboard: true %>
  </div>
  </div>
  </div>

  <script>
    function triggerShake() {
      const mainContent = document.querySelector('main') || document.body;
      mainContent.classList.add('shake');
      setTimeout(() => {
        mainContent.classList.remove('shake');
      }, 300);
    }

    if (typeof window.lastYearNavTime === 'undefined') {
      window.lastYearNavTime = 0;
    }

    window.handleYearNavKeydown = function(event) {
      if (event.repeat) return;

      const now = Date.now();
      if (now - window.lastYearNavTime < 500) return; 

      if (event.key === 'ArrowLeft') {
        const link = document.getElementById('prev-year-link');
        const disabled = document.getElementById('prev-year-disabled');
        if (link) {
          window.lastYearNavTime = now;
          if (window.Turbo) {
            window.Turbo.visit(link.href);
          } else {
            link.click();
          }
        } else if (disabled) {
          triggerShake();
        }
      } else if (event.key === 'ArrowRight') {
        const link = document.getElementById('next-year-link');
        const disabled = document.getElementById('next-year-disabled');
        if (link) {
          window.lastYearNavTime = now;
          if (window.Turbo) {
            window.Turbo.visit(link.href);
          } else {
            link.click();
          }
        } else if (disabled) {
          triggerShake();
        }
      }
    };

    document.removeEventListener('keydown', window.handleYearNavKeydown);
    document.addEventListener('keydown', window.handleYearNavKeydown);
  </script>
</div>

