<div class="mb-4">
  <!-- Header & Navigation -->
  <div class="d-flex justify-content-center align-items-center mb-4">
    <div class="d-flex align-items-center">
      <% if @prev_month_valid %>
        <%= link_to monthly_overview_path(year: @prev_month.year, month: @prev_month.month), id: 'prev-month-link', class: 'btn btn-outline-secondary me-3' do %>
          <i class="bi bi-chevron-left"></i>
        <% end %>
      <% else %>
        <button class="btn btn-outline-secondary me-3" disabled id="prev-month-disabled" onclick="triggerShake()"><i class="bi bi-chevron-left"></i></button>
      <% end %>
      
      <h3 class="m-0" style="min-width: 220px; text-align: center; display: inline-block;"><%= @selected_date.strftime("%B %Y") %></h3>
      
      <% if @next_month_valid %>
        <%= link_to monthly_overview_path(year: @next_month.year, month: @next_month.month), id: 'next-month-link', class: 'btn btn-outline-secondary ms-3' do %>
          <i class="bi bi-chevron-right"></i>
        <% end %>
      <% else %>
        <button class="btn btn-outline-secondary ms-3" disabled id="next-month-disabled" onclick="triggerShake()"><i class="bi bi-chevron-right"></i></button>
      <% end %>
    </div>
  </div>

  <script>
    function triggerShake() {
      const mainContent = document.querySelector('main') || document.body;
      mainContent.classList.add('shake');
      setTimeout(() => {
        mainContent.classList.remove('shake');
      }, 300);
    }

    if (typeof window.lastNavTime === 'undefined') {
      window.lastNavTime = 0;
    }

    // Define the handler function globally so we can remove it to prevent duplicates
    window.handleMonthNavKeydown = function(event) {
      if (event.repeat) return;

      const now = Date.now();
      if (now - window.lastNavTime < 500) return; 

      if (event.key === 'ArrowLeft') {
        const link = document.getElementById('prev-month-link');
        const disabled = document.getElementById('prev-month-disabled');
        if (link) {
          window.lastNavTime = now;
          if (window.Turbo) {
            window.Turbo.visit(link.href);
          } else {
            link.click();
          }
        } else if (disabled) {
          triggerShake();
        }
      } else if (event.key === 'ArrowRight') {
        const link = document.getElementById('next-month-link');
        const disabled = document.getElementById('next-month-disabled');
        if (link) {
          window.lastNavTime = now;
          if (window.Turbo) {
            window.Turbo.visit(link.href);
          } else {
            link.click();
          }
        } else if (disabled) {
          triggerShake();
        }
      }
    };

    // Clean up previous listener if it exists (though exact reference might be lost on reload, this helps for back/forward cache)
    document.removeEventListener('keydown', window.handleMonthNavKeydown);
    document.addEventListener('keydown', window.handleMonthNavKeydown);
  </script>

  <div class="row">
    <!-- Charts Column (Left) -->
    <div class="col-lg-5 mb-4">
      <!-- Income Comparison -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header">
          <h5 class="card-title m-0">Income Comparison</h5>
        </div>
        <div class="card-body">
          <div style="height: 250px;">
            <canvas
              data-controller="charts"
              data-charts-type-value="bar"
              data-charts-data-value="<%= @income_comparison_data.to_json %>"
              data-charts-options-value="<%= {
                indexAxis: 'y',
                maintainAspectRatio: false,
                scales: { x: { beginAtZero: true } },
                plugins: { legend: { position: 'bottom' } }
              }.to_json %>"
            ></canvas>
          </div>
        </div>
      </div>

      <!-- Expense Comparison -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header">
          <h5 class="card-title m-0">Expense Comparison</h5>
        </div>
        <div class="card-body">
          <div style="height: 350px;">
            <canvas
              data-controller="charts"
              data-charts-type-value="bar"
              data-charts-data-value="<%= @expense_comparison_data.to_json %>"
              data-charts-options-value="<%= {
                indexAxis: 'y',
                maintainAspectRatio: false,
                scales: { x: { beginAtZero: true } },
                plugins: { legend: { position: 'bottom' } }
              }.to_json %>"
            ></canvas>
          </div>
        </div>
      </div>

      <!-- Savings Comparison -->
      <div class="card shadow-sm">
        <div class="card-header">
          <h5 class="card-title m-0">Savings Comparison</h5>
        </div>
        <div class="card-body">
          <div style="height: 250px;">
            <canvas
              data-controller="charts"
              data-charts-type-value="bar"
              data-charts-data-value="<%= @savings_comparison_data.to_json %>"
              data-charts-options-value="<%= {
                indexAxis: 'y',
                maintainAspectRatio: false,
                scales: { x: { beginAtZero: true } },
                plugins: { legend: { position: 'bottom' } }
              }.to_json %>"
            ></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Detailed Table Column (Right) -->
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-header">
          <h5 class="card-title m-0">Monthly Details</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="bg-light">
                <tr>
                  <th style="width: 30%;">Category</th>
                  <th style="width: 25%;">Progress</th>
                  <th class="text-end" style="width: 15%;">Actual</th>
                  <th class="text-end" style="width: 15%;">Budget</th>
                  <th class="text-end" style="width: 15%;">vs Last Year</th>
                </tr>
              </thead>
              <tbody>
                <% ['income', 'expense', 'savings'].each do |type| %>
                  <% categories = @monthly_details.values.select { |d| d[:category].category_type == type }.sort_by { |d| d[:category].name } %>
                  
                  <% if categories.any? %>
                    <tr class="table-light no-hover-highlight">
                      <td colspan="5" class="fw-bold text-uppercase text-muted ps-3"><%= type %></td>
                    </tr>
                    
                    <% categories.each do |detail| %>
                      <!-- Main Category Row -->
                      <tr>
                        <td class="fw-bold"><%= detail[:category].name %></td>
                        <td>
                          <% if detail[:budget] > 0 %>
                            <% status_color = type == 'income' ? 'success' : (type == 'expense' ? (detail[:actual] > detail[:budget] ? 'danger' : 'success') : 'primary') %>
                            <div class="d-flex align-items-center">
                              <div class="progress flex-grow-1" style="height: 8px; background-color: rgba(0,0,0,0.03);">
                                <div class="progress-bar bg-<%= status_color %> bg-opacity-50 border border-<%= status_color %>" 
                                     role="progressbar" 
                                     style="width: <%= [detail[:percent], 100].min %>%;" 
                                     aria-valuenow="<%= detail[:percent] %>" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100"></div>
                              </div>
                              <small class="text-muted ms-2" style="font-size: 0.7rem; min-width: 30px;"><%= number_to_percentage(detail[:percent], precision: 0) %></small>
                            </div>
                          <% else %>
                            <span class="text-muted small">No Budget</span>
                          <% end %>
                        </td>
                        <td class="text-end fw-bold"><%= number_to_currency(detail[:actual] / 100.0) %></td>
                        <td class="text-end text-muted"><%= number_to_currency(detail[:budget] / 100.0) %></td>
                        <td class="text-end">
                           <% diff = detail[:actual] - detail[:prev_actual] %>
                           <span class="<%= diff >= 0 ? 'text-success' : 'text-danger' %>">
                             <%= diff >= 0 ? '+' : '' %><%= number_to_currency(diff / 100.0) %>
                           </span>
                        </td>
                      </tr>

                      <!-- Subcategories -->
                      <% detail[:subcategories].each do |sub| %>
                        <tr style="font-size: 0.9rem;">
                          <td class="ps-4 text-muted">
                            <i class="bi bi-arrow-return-right me-2"></i><%= sub[:category].name %>
                          </td>
                          <td>
                            <% if sub[:budget] > 0 %>
                              <% sub_status_color = type == 'income' ? 'success' : (type == 'expense' ? (sub[:actual] > sub[:budget] ? 'danger' : 'success') : 'primary') %>
                              <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1" style="height: 4px; background-color: rgba(0,0,0,0.03);">
                                  <div class="progress-bar bg-<%= sub_status_color %> bg-opacity-50 border border-<%= sub_status_color %>" 
                                       role="progressbar" 
                                       style="width: <%= [sub[:percent], 100].min %>%;"></div>
                                </div>
                                <small class="text-muted ms-2" style="font-size: 0.7rem; min-width: 30px;"><%= number_to_percentage(sub[:percent], precision: 0) %></small>
                              </div>
                            <% end %>
                          </td>
                          <td class="text-end"><%= number_to_currency(sub[:actual] / 100.0) %></td>
                          <td class="text-end text-muted"><%= number_to_currency(sub[:budget] / 100.0) %></td>
                          <td class="text-end text-muted small">
                            <%= number_to_currency((sub[:actual] - sub[:prev_actual]) / 100.0) %>
                          </td>
                        </tr>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
