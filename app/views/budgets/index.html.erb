<div class="mb-4">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="card-title m-0">Budgets</h5>
      <div class="dropdown">
        <button class="btn btn-primary dropdown-toggle btn-sm" type="button" id="actionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          Actions
        </button>
        <ul class="dropdown-menu" aria-labelledby="actionsDropdown">
          <li><%= link_to "Add Budget", new_budget_path(year: @selected_year), class: "dropdown-item" %></li>
          <li><%= link_to "Import Budgets", import_form_budgets_path, class: "dropdown-item" %></li>
          <li><%= button_to "Copy Yearly Budgets to #{@next_year}", copy_yearly_budgets_budgets_path(year: @selected_year), method: :post, class: "dropdown-item", data: { confirm: "Are you sure you want to copy all yearly budgets to #{@next_year}?" } %></li>
        </ul>
      </div>
    </div>
    <div class="card-body p-0">
      <% if @budgets.present? %>
        <div class="horizontal-scroll">
      <table class="table table-bordered table-hover align-middle">
        <tbody>
          <% income_categories = @categories.select { |c| c.category_type == 'income' && c.parent_category.nil? } %>
          <% expense_categories = @categories.select { |c| c.category_type == 'expense' && c.parent_category.nil? } %>
          <% savings_categories = @categories.select { |c| c.category_type == 'savings' && c.parent_category.nil? } %>

          <% if income_categories.any? %>
            <tr class="table-light no-hover-highlight">
              <td colspan="14" class="fw-bold text-uppercase text-muted ps-3">Income</td>
            </tr>
            <tr class="highlight">
              <td class="text-center"><strong>Category</strong></td>
              <% (1..12).each do |month| %>
                <td class="text-center"><strong><%= Date::MONTHNAMES[month] %></strong></td>
              <% end %>
              <td class="text-center"><strong>Actions</strong></td>
            </tr>
            <% income_categories.each do |category| %>
              <tr>
                <% yearly_budget = @budgets.find { |b| b.category == category && b.month.nil? } %>
                <td <% if yearly_budget %>data-controller="clickable-row" data-clickable-row-url-value="<%= budget_path(yearly_budget) %>" data-action="click->clickable-row#click" style="cursor: pointer;"<% end %>>
                  <%= category.name %>
                </td>
                <% (1..12).each do |month_index| %>
                  <% monthly_budget = @budgets.find { |b| b.category == category && b.month == month_index } %>
                  <% yearly_budget = @budgets.find { |b| b.category == category && b.month.nil? } %>
                  <% subcategory_budgets = category.subcategories.sum do |subcategory| %>
                    <% subcategory_monthly_budget = @budgets.find { |b| b.category == subcategory && b.month == month_index } %>
                    <% subcategory_yearly_budget = @budgets.find { |b| b.category == subcategory && b.month.nil? } %>
                    <% subcategory_monthly_budget ? subcategory_monthly_budget.budgeted_amount : (subcategory_yearly_budget ? subcategory_yearly_budget.budgeted_amount : 0) %>
                  <% end %>
                  <% budgeted_amount = monthly_budget ? monthly_budget.budgeted_amount : (yearly_budget ? yearly_budget.budgeted_amount : 0) %>
                  <% total_budgeted_amount = budgeted_amount + subcategory_budgets %>
                  <% target_budget = monthly_budget || yearly_budget %>
                  <td <% if target_budget %>data-controller="clickable-row tooltip" data-clickable-row-url-value="<%= budget_path(target_budget) %>" data-action="click->clickable-row#click" style="cursor: pointer;" data-bs-toggle="tooltip" title="<%= monthly_budget ? 'View override' : 'View yearly' %>"<% end %>>
                    <% if monthly_budget %>
                      <span class="text-info"><%= number_to_currency(total_budgeted_amount / 100.0) %></span>
                    <% else %>
                      <%= number_to_currency(total_budgeted_amount / 100.0) %>
                    <% end %>
                  </td>
                <% end %>
                <td onclick="event.stopPropagation()">
  <% if yearly_budget %>
    <%= link_to edit_budget_path(yearly_budget), class: 'btn btn-warning btn-sm', title: 'Edit', data: { controller: 'tooltip', bs_toggle: 'tooltip' } do %>
      <i class="bi bi-pencil"></i>
    <% end %>
    <%= link_to yearly_budget, data: { turbo_method: :delete, turbo_confirm: 'Are you sure?', controller: 'tooltip', bs_toggle: 'tooltip' }, class: 'btn btn-danger btn-sm', title: 'Delete' do %>
      <i class="bi bi-trash"></i>
    <% end %>
  <% else %>
    <%= link_to new_budget_path(category_id: category.id, year: @selected_year), class: 'btn btn-primary btn-sm', title: 'Add Budget', data: { controller: 'tooltip', bs_toggle: 'tooltip' } do %>
      <i class="bi bi-plus-lg"></i>
    <% end %>
  <% end %>
</td>

              </tr>
              <% category.subcategories.each do |subcategory| %>
                <tr>
                  <% yearly_budget = @budgets.find { |b| b.category == subcategory && b.month.nil? } %>
                  <td class="pl-4 text-muted" <% if yearly_budget %>data-controller="clickable-row" data-clickable-row-url-value="<%= budget_path(yearly_budget) %>" data-action="click->clickable-row#click" style="cursor: pointer;"<% end %>>
                    <i class="bi bi-arrow-return-right me-2"></i> <%= subcategory.name %>
                  </td>
                  <% (1..12).each do |month_index| %>
                    <% monthly_budget = @budgets.find { |b| b.category == subcategory && b.month == month_index } %>
                    <% yearly_budget = @budgets.find { |b| b.category == subcategory && b.month.nil? } %>
                    <% budgeted_amount = monthly_budget ? monthly_budget.budgeted_amount : (yearly_budget ? yearly_budget.budgeted_amount : 0) %>
                    <% target_budget = monthly_budget || yearly_budget %>
                    <td <% if target_budget %>data-controller="clickable-row tooltip" data-clickable-row-url-value="<%= budget_path(target_budget) %>" data-action="click->clickable-row#click" style="cursor: pointer;" data-bs-toggle="tooltip" title="<%= monthly_budget ? 'View override' : 'View yearly' %>"<% end %>>
                      <% if monthly_budget %>
                        <span class="text-info"><%= number_to_currency(budgeted_amount / 100.0) %></span>
                      <% else %>
                        <%= number_to_currency(budgeted_amount / 100.0) %>
                      <% end %>
                    </td>
                  <% end %>
                  <td onclick="event.stopPropagation()">
  <% if yearly_budget %>
    <%= link_to edit_budget_path(yearly_budget), class: 'btn btn-warning btn-sm', title: 'Edit', data: { controller: 'tooltip', bs_toggle: 'tooltip' } do %>
      <i class="bi bi-pencil"></i>
    <% end %>
    <%= link_to yearly_budget, data: { turbo_method: :delete, turbo_confirm: 'Are you sure?', controller: 'tooltip', bs_toggle: 'tooltip' }, class: 'btn btn-danger btn-sm', title: 'Delete' do %>
      <i class="bi bi-trash"></i>
    <% end %>
  <% else %>
    <%= link_to new_budget_path(category_id: subcategory.id, year: @selected_year), class: 'btn btn-primary btn-sm', title: 'Add Budget', data: { controller: 'tooltip', bs_toggle: 'tooltip' } do %>
      <i class="bi bi-plus-lg"></i>
    <% end %>
  <% end %>
</td>

                </tr>
              <% end %>
            <% end %>
          <% else %>
            <tr>
              <td colspan="14">No income categories found</td>
            </tr>
          <% end %>

          <% if expense_categories.any? %>
            <tr class="table-light no-hover-highlight">
              <td colspan="14" class="fw-bold text-uppercase text-muted ps-3">Expenses</td>
            </tr>
            <tr class="highlight">
              <td class="text-center"><strong>Category</strong></td>
              <% (1..12).each do |month| %>
                <td class="text-center"><strong><%= Date::MONTHNAMES[month] %></strong></td>
              <% end %>
              <td class="text-center"><strong>Actions</strong></td>
            </tr>
            <% expense_categories.each do |category| %>
              <tr>
                <% yearly_budget = @budgets.find { |b| b.category == category && b.month.nil? } %>
                <td <% if yearly_budget %>data-controller="clickable-row" data-clickable-row-url-value="<%= budget_path(yearly_budget) %>" data-action="click->clickable-row#click" style="cursor: pointer;"<% end %>>
                  <%= category.name %>
                </td>
                <% (1..12).each do |month_index| %>
                  <% monthly_budget = @budgets.find { |b| b.category == category && b.month == month_index } %>
                  <% yearly_budget = @budgets.find { |b| b.category == category && b.month.nil? } %>
                  <% subcategory_budgets = category.subcategories.sum do |subcategory| %>
                    <% subcategory_monthly_budget = @budgets.find { |b| b.category == subcategory && b.month == month_index } %>
                    <% subcategory_yearly_budget = @budgets.find { |b| b.category == subcategory && b.month.nil? } %>
                    <% subcategory_monthly_budget ? subcategory_monthly_budget.budgeted_amount : (subcategory_yearly_budget ? subcategory_yearly_budget.budgeted_amount : 0) %>
                  <% end %>
                  <% budgeted_amount = monthly_budget ? monthly_budget.budgeted_amount : (yearly_budget ? yearly_budget.budgeted_amount : 0) %>
                  <% total_budgeted_amount = budgeted_amount + subcategory_budgets %>
                  <% target_budget = monthly_budget || yearly_budget %>
                  <td <% if target_budget %>data-controller="clickable-row tooltip" data-clickable-row-url-value="<%= budget_path(target_budget) %>" data-action="click->clickable-row#click" style="cursor: pointer;" data-bs-toggle="tooltip" title="<%= monthly_budget ? 'View override' : 'View yearly' %>"<% end %>>
                    <% if monthly_budget %>
                      <span class="text-info"><%= number_to_currency(total_budgeted_amount / 100.0) %></span>
                    <% else %>
                      <%= number_to_currency(total_budgeted_amount / 100.0) %>
                    <% end %>
                  </td>
                <% end %>
                <td onclick="event.stopPropagation()">
  <% if yearly_budget %>
    <%= link_to edit_budget_path(yearly_budget), class: 'btn btn-warning btn-sm', title: 'Edit', data: { controller: 'tooltip', bs_toggle: 'tooltip' } do %>
      <i class="bi bi-pencil"></i>
    <% end %>
    <%= link_to yearly_budget, data: { turbo_method: :delete, turbo_confirm: 'Are you sure?', controller: 'tooltip', bs_toggle: 'tooltip' }, class: 'btn btn-danger btn-sm', title: 'Delete' do %>
      <i class="bi bi-trash"></i>
    <% end %>
  <% else %>
    <%= link_to new_budget_path(category_id: category.id, year: @selected_year), class: 'btn btn-primary btn-sm', title: 'Add Budget', data: { controller: 'tooltip', bs_toggle: 'tooltip' } do %>
      <i class="bi bi-plus-lg"></i>
    <% end %>
  <% end %>
</td>

              </tr>
              <% category.subcategories.each do |subcategory| %>
                <tr>
                  <% yearly_budget = @budgets.find { |b| b.category == subcategory && b.month.nil? } %>
                  <td class="pl-4 text-muted" <% if yearly_budget %>data-controller="clickable-row" data-clickable-row-url-value="<%= budget_path(yearly_budget) %>" data-action="click->clickable-row#click" style="cursor: pointer;"<% end %>>
                    <i class="bi bi-arrow-return-right me-2"></i> <%= subcategory.name %>
                  </td>
                  <% (1..12).each do |month_index| %>
                    <% monthly_budget = @budgets.find { |b| b.category == subcategory && b.month == month_index } %>
                    <% yearly_budget = @budgets.find { |b| b.category == subcategory && b.month.nil? } %>
                    <% budgeted_amount = monthly_budget ? monthly_budget.budgeted_amount : (yearly_budget ? yearly_budget.budgeted_amount : 0) %>
                    <% target_budget = monthly_budget || yearly_budget %>
                    <td <% if target_budget %>data-controller="clickable-row tooltip" data-clickable-row-url-value="<%= budget_path(target_budget) %>" data-action="click->clickable-row#click" style="cursor: pointer;" data-bs-toggle="tooltip" title="<%= monthly_budget ? 'View override' : 'View yearly' %>"<% end %>>
                      <% if monthly_budget %>
                        <span class="text-info"><%= number_to_currency(budgeted_amount / 100.0) %></span>
                      <% else %>
                        <%= number_to_currency(budgeted_amount / 100.0) %>
                      <% end %>
                    </td>
                  <% end %>
                  <td onclick="event.stopPropagation()">
  <% if yearly_budget %>
    <%= link_to edit_budget_path(yearly_budget), class: 'btn btn-warning btn-sm', title: 'Edit', data: { controller: 'tooltip', bs_toggle: 'tooltip' } do %>
      <i class="bi bi-pencil"></i>
    <% end %>
    <%= link_to yearly_budget, data: { turbo_method: :delete, turbo_confirm: 'Are you sure?', controller: 'tooltip', bs_toggle: 'tooltip' }, class: 'btn btn-danger btn-sm', title: 'Delete' do %>
      <i class="bi bi-trash"></i>
    <% end %>
  <% else %>
    <%= link_to new_budget_path(category_id: subcategory.id, year: @selected_year), class: 'btn btn-primary btn-sm', title: 'Add Budget', data: { controller: 'tooltip', bs_toggle: 'tooltip' } do %>
      <i class="bi bi-plus-lg"></i>
    <% end %>
  <% end %>
</td>

                </tr>
              <% end %>
            <% end %>
          <% else %>
            <tr>
              <td colspan="14">No expense categories found</td>
            </tr>
          <% end %>

          <% if savings_categories.any? %>
            <tr class="table-light no-hover-highlight">
              <td colspan="14" class="fw-bold text-uppercase text-muted ps-3">Savings</td>
            </tr>
            <tr class="highlight">
              <td class="text-center"><strong>Category</strong></td>
              <% (1..12).each do |month| %>
                <td class="text-center"><strong><%= Date::MONTHNAMES[month] %></strong></td>
              <% end %>
              <td class="text-center"><strong>Actions</strong></td>
            </tr>
            <% savings_categories.each do |category| %>
              <tr>
                <% yearly_budget = @budgets.find { |b| b.category == category && b.month.nil? } %>
                <td <% if yearly_budget %>data-controller="clickable-row" data-clickable-row-url-value="<%= budget_path(yearly_budget) %>" data-action="click->clickable-row#click" style="cursor: pointer;"<% end %>>
                  <%= category.name %>
                </td>
                <% (1..12).each do |month_index| %>
                  <% monthly_budget = @budgets.find { |b| b.category == category && b.month == month_index } %>
                  <% yearly_budget = @budgets.find { |b| b.category == category && b.month.nil? } %>
                  <% subcategory_budgets = category.subcategories.sum do |subcategory| %>
                    <% subcategory_monthly_budget = @budgets.find { |b| b.category == subcategory && b.month == month_index } %>
                    <% subcategory_yearly_budget = @budgets.find { |b| b.category == subcategory && b.month.nil? } %>
                    <% subcategory_monthly_budget ? subcategory_monthly_budget.budgeted_amount : (subcategory_yearly_budget ? subcategory_yearly_budget.budgeted_amount : 0) %>
                  <% end %>
                  <% budgeted_amount = monthly_budget ? monthly_budget.budgeted_amount : (yearly_budget ? yearly_budget.budgeted_amount : 0) %>
                  <% total_budgeted_amount = budgeted_amount + subcategory_budgets %>
                  <% target_budget = monthly_budget || yearly_budget %>
                  <td <% if target_budget %>data-controller="clickable-row tooltip" data-clickable-row-url-value="<%= budget_path(target_budget) %>" data-action="click->clickable-row#click" style="cursor: pointer;" data-bs-toggle="tooltip" title="<%= monthly_budget ? 'View override' : 'View yearly' %>"<% end %>>
                    <% if monthly_budget %>
                      <span class="text-info"><%= number_to_currency(total_budgeted_amount / 100.0) %></span>
                    <% else %>
                      <%= number_to_currency(total_budgeted_amount / 100.0) %>
                    <% end %>
                  </td>
                <% end %>
                <td onclick="event.stopPropagation()">
  <% if yearly_budget %>
    <%= link_to edit_budget_path(yearly_budget), class: 'btn btn-warning btn-sm', title: 'Edit', data: { controller: 'tooltip', bs_toggle: 'tooltip' } do %>
      <i class="bi bi-pencil"></i>
    <% end %>
    <%= link_to yearly_budget, data: { turbo_method: :delete, turbo_confirm: 'Are you sure?', controller: 'tooltip', bs_toggle: 'tooltip' }, class: 'btn btn-danger btn-sm', title: 'Delete' do %>
      <i class="bi bi-trash"></i>
    <% end %>
  <% else %>
    <%= link_to new_budget_path(category_id: category.id, year: @selected_year), class: 'btn btn-primary btn-sm', title: 'Add Budget', data: { controller: 'tooltip', bs_toggle: 'tooltip' } do %>
      <i class="bi bi-plus-lg"></i>
    <% end %>
  <% end %>
</td>

              </tr>
              <% category.subcategories.each do |subcategory| %>
                <tr>
                  <% yearly_budget = @budgets.find { |b| b.category == subcategory && b.month.nil? } %>
                  <td class="pl-4 text-muted" <% if yearly_budget %>data-controller="clickable-row" data-clickable-row-url-value="<%= budget_path(yearly_budget) %>" data-action="click->clickable-row#click" style="cursor: pointer;"<% end %>>
                    <i class="bi bi-arrow-return-right me-2"></i> <%= subcategory.name %>
                  </td>
                  <% (1..12).each do |month_index| %>
                    <% monthly_budget = @budgets.find { |b| b.category == subcategory && b.month == month_index } %>
                    <% yearly_budget = @budgets.find { |b| b.category == subcategory && b.month.nil? } %>
                    <% budgeted_amount = monthly_budget ? monthly_budget.budgeted_amount : (yearly_budget ? yearly_budget.budgeted_amount : 0) %>
                    <% target_budget = monthly_budget || yearly_budget %>
                    <td <% if target_budget %>data-controller="clickable-row tooltip" data-clickable-row-url-value="<%= budget_path(target_budget) %>" data-action="click->clickable-row#click" style="cursor: pointer;" data-bs-toggle="tooltip" title="<%= monthly_budget ? 'View override' : 'View yearly' %>"<% end %>>
                      <% if monthly_budget %>
                        <span class="text-info"><%= number_to_currency(budgeted_amount / 100.0) %></span>
                      <% else %>
                        <%= number_to_currency(budgeted_amount / 100.0) %>
                      <% end %>
                    </td>
                  <% end %>
                  <td onclick="event.stopPropagation()">
  <% if yearly_budget %>
    <%= link_to edit_budget_path(yearly_budget), class: 'btn btn-warning btn-sm', title: 'Edit', data: { controller: 'tooltip', bs_toggle: 'tooltip' } do %>
      <i class="bi bi-pencil"></i>
    <% end %>
    <%= link_to yearly_budget, data: { turbo_method: :delete, turbo_confirm: 'Are you sure?', controller: 'tooltip', bs_toggle: 'tooltip' }, class: 'btn btn-danger btn-sm', title: 'Delete' do %>
      <i class="bi bi-trash"></i>
    <% end %>
  <% else %>
    <%= link_to new_budget_path(category_id: subcategory.id, year: @selected_year), class: 'btn btn-primary btn-sm', title: 'Add Budget', data: { controller: 'tooltip', bs_toggle: 'tooltip' } do %>
      <i class="bi bi-plus-lg"></i>
    <% end %>
  <% end %>
</td>

                </tr>
              <% end %>
            <% end %>
          <% else %>
            <tr>
              <td colspan="14">No savings categories found</td>
            </tr>
          <% end %>
        </tbody>
      </table>
        </div>
      <% else %>
        <div class="text-center py-5">
          <h3 class="text-muted">No budgets found</h3>
          <p class="text-muted">Try adding new budgets or importing them.</p>
        </div>
      <% end %>
    </div>
  </div>
</div>