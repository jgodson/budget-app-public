<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header h4 d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <button type="button" class="btn btn-link text-body p-0 me-3 text-decoration-none" onclick="history.back()" data-controller="tooltip" data-bs-toggle="tooltip" title="Back">
              <i class="bi bi-arrow-left"></i>
            </button>
            Goal: <%= @goal.goal_name %>
          </div>
          <div class="d-flex align-items-center gap-2">
            <% if @goal.archived? %>
              <span class="badge bg-secondary">Archived <%= @goal.archived_at.year %></span>
            <% end %>

            <% unless @goal.archived? %>
              <%= link_to new_transaction_path({category_id: @goal.category, description: "Contribution to #{@goal.goal_name} goal"}), class: 'btn btn-sm btn-success', title: 'Add Contribution', data: { controller: 'tooltip', bs_toggle: 'tooltip' } do %>
                <i class="bi bi-plus-lg"></i>
              <% end %>
            <% end %>

            <%= link_to edit_goal_path(@goal), class: 'btn btn-sm btn-warning', title: 'Edit', data: { controller: 'tooltip', bs_toggle: 'tooltip' } do %>
              <i class="bi bi-pencil"></i>
            <% end %>

            <% if @goal.archived? %>
              <%= link_to unarchive_goal_path(@goal), title: 'Unarchive', data: { turbo_method: :patch, turbo_confirm: "Are you sure you want to unarchive #{@goal.goal_name}?", controller: 'tooltip', bs_toggle: 'tooltip' }, class: 'btn btn-sm btn-secondary' do %>
                <i class="bi bi-box-arrow-up"></i>
              <% end %>
            <% else %>
              <%= link_to archive_goal_path(@goal), title: 'Archive', data: { turbo_method: :patch, turbo_confirm: "Are you sure you want to archive #{@goal.goal_name}?", controller: 'tooltip', bs_toggle: 'tooltip' }, class: 'btn btn-sm btn-secondary' do %>
                <i class="bi bi-archive"></i>
              <% end %>
            <% end %>

            <%= link_to goal_path(@goal), title: 'Delete', data: { turbo_method: :delete, turbo_confirm: 'Are you sure?', controller: 'tooltip', bs_toggle: 'tooltip' }, class: 'btn btn-sm btn-danger' do %>
              <i class="bi bi-trash"></i>
            <% end %>
          </div>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-center mb-4">
            <span class="text-muted text-uppercase small fw-bold me-3">Category</span>
            <%= link_to category_path(@goal.category), class: "text-decoration-none" do %>
              <span class="badge rounded-pill bg-light text-dark border px-3 py-2 shadow-sm">
                <i class="bi bi-tag-fill me-2 text-success"></i><%= @goal.category.name %>
              </span>
            <% end %>
          </div>

          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <strong>Progress:</strong>
              <div>
                <% if @goal.complete? %>
                  <small class="text-success me-2 fw-bold">Goal Complete <%= @goal.category.transactions.order(date: :desc).first&.date&.strftime("%B %Y") %></small>
                <% end %>
                <small class="text-muted"><%= number_to_percentage(@goal.percent_complete, precision: 1) %></small>
              </div>
            </div>
            <div class="progress" style="height: 20px;">
              <div class="progress-bar <%= @goal.complete? ? 'bg-success' : '' %>" role="progressbar" style="width: <%= @goal.percent_complete %>%; background-color: <%= @goal.complete? ? '' : 'rgba(25, 135, 84, 0.5)' %>;" aria-valuenow="<%= @goal.percent_complete %>" aria-valuemin="0" aria-valuemax="100">
                <%= number_to_percentage(@goal.percent_complete, precision: 1) %>
              </div>
            </div>
            <div class="text-end text-muted small mt-1">
              <%= number_to_currency(@goal.total_contributed_dollars) %> / <%= number_to_currency(@goal.amount / 100.0) %>
            </div>
          </div>

          <div class="row mb-4 g-3">
            <div class="col-md-6">
              <div class="card h-100 border-0 shadow-sm bg-light">
                <div class="card-body text-center">
                  <h6 class="card-subtitle mb-2 text-muted text-uppercase small">Total Contributions</h6>
                  <h4 class="card-title mb-0 fw-bold text-success"><%= number_to_currency(@goal.total_contributed_dollars) %></h4>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card h-100 border-0 shadow-sm bg-light">
                <div class="card-body text-center">
                  <h6 class="card-subtitle mb-2 text-muted text-uppercase small">Goal Amount</h6>
                  <h4 class="card-title mb-0 fw-bold"><%= number_to_currency(@goal.amount / 100.0) %></h4>
                </div>
              </div>
            </div>
          </div>

          <% if @goal.total_contributed_dollars > 0 %>
            <div class="card mb-4">
              <div class="card-header h5">
                Contributions Over Time
              </div>
              <div class="card-body" style="height: 300px;">
                <canvas
                  data-controller="charts"
                  data-charts-type-value="line"
                  data-charts-data-value="<%= @contributions_chart_data.to_json %>"
                  data-charts-options-value="<%= {
                    plugins: { legend: { display: true, position: 'bottom' } },
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, suggestedMax: @goals_chart_max } },
                    interaction: {
                      mode: 'index',
                      intersect: false,
                    }
                  }.to_json %>"
                ></canvas>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>Year</th>
                    <th>Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <% @goal.total_contributed_by_year.each do |year, amount| %>
                    <tr>
                      <td><%= year %></td>
                      <td><%= number_to_currency(amount / 100.0) %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <p>
              No contributions towards this goal yet.
            </p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>