<% return_to = request.fullpath %>
<div class="mb-4">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="card-title m-0">Transactions</h5>
      <div class="dropdown">
        <button class="btn btn-primary dropdown-toggle btn-sm" type="button" id="actionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          Actions
        </button>
        <ul class="dropdown-menu" aria-labelledby="actionsDropdown">
          <li><%= link_to new_transaction_path(return_to: return_to), class: "dropdown-item" do %>
            <i class="bi bi-plus-lg me-2"></i>Add Transaction
          <% end %></li>
          <li><%= link_to import_form_transactions_path, class: "dropdown-item" do %>
            <i class="bi bi-upload me-2"></i>Import Transactions
          <% end %></li>
        </ul>
      </div>
    </div>
    <div class="card-body p-0">
      <!-- Filters -->
      <%= form_with url: transactions_path, method: :get, data: { turbo_frame: "transactions_list" }, class: "p-3" do %>
        <div class="row g-3">
          <div class="col-sm-6 col-lg-auto pb-2">
            <%= label_tag :year, "Select Year:", class: "form-label" %>
            <%= select_tag :year, options_for_select(@available_years, @selected_year.to_i), class: "form-select", onchange: "this.form.requestSubmit();" %>
          </div>
          <div class="col-sm-6 col-lg-2 pb-2">
            <%= label_tag :month, "Select Month:", class: "form-label" %>
            <%= select_tag :month, options_for_select([['', '']] + Date::MONTHNAMES.compact.each_with_index.map { |name, index| [name, index + 1] }, @selected_month.to_i), class: "form-select", onchange: "this.form.requestSubmit();" %>
          </div>
          <div class="col-sm-6 col-lg-3 pb-2" data-controller="select-filter" data-select-filter-submit-form-value="true">
            <%= label_tag :category, "Select Category:", class: "form-label" %>
            <% category_input_id = "category_filter" %>
            <input type="text" class="form-control" id="<%= category_input_id %>" data-select-filter-target="input" data-action="input->select-filter#filter keydown->select-filter#handleKeydown focus->select-filter#openDropdown blur->select-filter#closeDropdown" />
            <%= select_tag :category, options_for_select([['', '']] + @categories.map { |c| [c.name, c.id] }, @selected_category.to_i), id: "#{category_input_id}_select", class: "form-select d-none", data: { select_filter_target: "select", action: "change->select-filter#syncInput" } %>
          </div>
          <div class="col-sm-6 col-lg-2 pb-2">
            <%= label_tag :source, "Select Source:", class: "form-label" %>
            <%= select_tag :source, options_for_select([['', '']] + @available_sources, @selected_source), class: "form-select", onchange: "this.form.requestSubmit();" %>
          </div>
          <div class="col-sm-6 col-lg-2 pb-2">
            <%= label_tag :group_by, "Group by:", class: "form-label" %>
            <%= select_tag :group_by, options_for_select(@group_by_options.map { |g| [g.titleize, g] }, @selected_group_by), class: "form-select", onchange: "this.form.requestSubmit();" %>
          </div>
          <div class="col-sm-6 col-lg-3 pb-2">
            <%= label_tag :description, "Filter by Description:", class: "form-label" %>
            <%= text_field_tag :description, params[:description], class: "form-control", oninput: "filterDescription()", onkeydown: "if (event.key === 'Enter') event.preventDefault()" %>
          </div>
        </div>
      <% end %>

      <%= turbo_frame_tag "transactions_list" do %>
      <div class="table-responsive mt-4">
    <table class="table table-bordered table-hover align-middle mb-0">
      <% @grouped_transactions.each do |date, transactions| %>
          <% header = @selected_group_by.include?('month') ? date.strftime("%B %Y") : "#{@selected_month.present? ? Date::MONTHNAMES[@selected_month] : ""} #{date}" %>
          <% parent_transactions = @selected_group_by.include?('category') ? transactions.values.flatten : transactions %>
          <% parent_totals = transaction_type_totals(parent_transactions) %>
          <tbody>
            <tr class="parent-<%= header.parameterize %> parent-group table-light no-hover-highlight">
              <td colspan="3"><h3 class="m-0"><%= header %></h3></td>
              <td class="text-end" style="width: 140px;"><h5 class="fw-bold m-0 transactions-total-value">Totals</h5></td>
              <td class="text-end" style="width: 140px;" data-amount-totals>
                <div class="d-flex flex-column align-items-end">
                  <small class="text-muted">Income</small>
                  <span class="text-success fw-bold transactions-total-value" data-total-type="income"><%= parent_totals[:income].zero? ? "-" : number_to_currency(parent_totals[:income]) %></span>
                </div>
              </td>
              <td class="text-end" style="width: 140px;" data-amount-totals>
                <div class="d-flex flex-column align-items-end">
                  <small class="text-muted">Expenses</small>
                  <span class="text-danger fw-bold transactions-total-value" data-total-type="expense"><%= parent_totals[:expense].zero? ? "-" : number_to_currency(parent_totals[:expense]) %></span>
                </div>
              </td>
              <td class="text-end" style="width: 140px;" data-amount-totals>
                <div class="d-flex flex-column align-items-end">
                  <small class="text-muted">Savings</small>
                  <span class="text-primary fw-bold transactions-total-value" data-total-type="savings"><%= parent_totals[:savings].zero? ? "-" : number_to_currency(parent_totals[:savings]) %></span>
                </div>
              </td>
            </tr>
          </tbody>
            <% if @selected_group_by.include?('category') %>
              <% transactions.each do |category, transactions| %>
                <% child_totals = transaction_type_totals(transactions) %>
                <tbody class="parent-<%= header.parameterize %> child-group table-group-divider">
                  <tr class="table-light no-hover-highlight">
                    <td colspan="3"><h5 class="fw-bold m-0 text-center"><%= category.name %></h5></td>
                    <td class="text-end" style="width: 140px;"><h5 class="fw-bold m-0 transactions-total-value">Totals</h5></td>
                    <td class="text-end" style="width: 140px;" data-amount-totals>
                      <div class="d-flex flex-column align-items-end">
                        <small class="text-muted">Income</small>
                        <span class="text-success fw-bold transactions-total-value" data-total-type="income"><%= child_totals[:income].zero? ? "-" : number_to_currency(child_totals[:income]) %></span>
                      </div>
                    </td>
                    <td class="text-end" style="width: 140px;" data-amount-totals>
                      <div class="d-flex flex-column align-items-end">
                        <small class="text-muted">Expenses</small>
                        <span class="text-danger fw-bold transactions-total-value" data-total-type="expense"><%= child_totals[:expense].zero? ? "-" : number_to_currency(child_totals[:expense]) %></span>
                      </div>
                    </td>
                    <td class="text-end" style="width: 140px;" data-amount-totals>
                      <div class="d-flex flex-column align-items-end">
                        <small class="text-muted">Savings</small>
                        <span class="text-primary fw-bold transactions-total-value" data-total-type="savings"><%= child_totals[:savings].zero? ? "-" : number_to_currency(child_totals[:savings]) %></span>
                      </div>
                    </td>
                  </tr>
                  <tr class="text-center highlight">
                    <td style="width: 200px;"><strong>Date</strong></td>
                    <td style="width: 160px;"><strong>Source</strong></td>
                    <td colspan="3"><strong>Description</strong></td>
                    <td style="width: 200px;"><strong>Amount</strong></td>
                    <td style="width: 100px;" class="text-center"><strong>Actions</strong></td>
                  </tr>
                  <% transactions.each do |transaction| %>
                    <tr class="transaction-row" data-controller="clickable-row" data-clickable-row-url-value="<%= transaction_path(transaction, return_to: return_to) %>" data-action="click->clickable-row#click" data-transaction-type="<%= transaction.transaction_type %>" style="cursor: pointer;">
                      <td><%= transaction.date.strftime("%d %B %Y") %></td>
                      <td class="text-center"><%= transaction_source_badge(transaction) %></td>
                      <td class="transaction-description" colspan="3"><%= transaction.description %></td>
                      <td class="transaction-amount"><%= number_to_currency(transaction.amount_dollars) %></td>
                      <td class="no-row-click">
                        <%= link_to edit_transaction_path(transaction, return_to: return_to), class: 'btn btn-warning btn-sm', title: 'Edit', aria: { label: 'Edit' }, data: { controller: 'tooltip', bs_toggle: 'tooltip', turbo_frame: '_top' } do %>
                          <i class="bi bi-pencil"></i>
                        <% end %>
                        <%= link_to transaction_path(transaction, return_to: return_to), data: { turbo_method: :delete, turbo_confirm: 'Are you sure?', controller: 'tooltip', bs_toggle: 'tooltip' }, class: 'btn btn-danger btn-sm', title: 'Delete' do %>
                          <i class="bi bi-trash"></i>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              <% end %>
            <% else %>
              <tbody class="parent-<%= header.parameterize %> child-group table-group-divider">
                                                <tr class="text-center table-light no-hover-highlight">
                                                  <td style="width: 200px;"><strong>Date</strong></td>
                                                  <td style="width: 160px;"><strong>Source</strong></td>
                                                  <td colspan="3"><strong>Description</strong></td>
                                                  <td style="width: 200px;"><strong>Amount</strong></td>
                                                  <td style="width: 200px;" class="text-center"><strong>Actions</strong></td>
                                                </tr>                <% transactions.each do |transaction| %>
                  <tr class="transaction-row" data-controller="clickable-row" data-clickable-row-url-value="<%= transaction_path(transaction, return_to: return_to) %>" data-action="click->clickable-row#click" data-transaction-type="<%= transaction.transaction_type %>" style="cursor: pointer;">
                    <td><%= transaction.date.strftime("%d %B %Y") %></td>
                    <td class="text-center"><%= transaction_source_badge(transaction) %></td>
                    <td class="transaction-description" colspan="3"><%= transaction.description %></td>
                    <td class="transaction-amount"><%= number_to_currency(transaction.amount_dollars) %></td>
                    <td class="no-row-click">
                      <%= link_to edit_transaction_path(transaction, return_to: return_to), class: 'btn btn-warning btn-sm', title: 'Edit', aria: { label: 'Edit' }, data: { controller: 'tooltip', bs_toggle: 'tooltip', turbo_frame: '_top' } do %>
                        <i class="bi bi-pencil"></i>
                      <% end %>
                      <%= link_to transaction_path(transaction, return_to: return_to), data: { turbo_method: :delete, turbo_confirm: 'Are you sure?', controller: 'tooltip', bs_toggle: 'tooltip' }, class: 'btn btn-danger btn-sm', title: 'Delete' do %>
                        <i class="bi bi-trash"></i>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            <% end %>
        <% end %>
    </table>
  </div>

      <div id="empty-state" class="text-center py-5" style="<% if @transactions.present?%>display: none;<% end %>">
        <h3 class="text-muted">No transactions found</h3>
        <p class="text-muted">Try adjusting your filters or adding new transactions.</p>
      </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  function filterDescription() {
    const input = document.querySelector('input[name="description"]');
    const filter = input.value.toLowerCase();
    const allParentGroups = document.querySelectorAll('tr.parent-group');
    const parentGroups = Array.from(allParentGroups).reduce((acc, group) => {
      const parentGroup = document.querySelector(`tr.${group.classList[0]}`);
      if (!acc.includes(group)) {
        acc.push(group);
      }
      return acc;
    }, []);
    let hasVisibleTransactions = false;

    const formatCurrency = (value) => (value === 0 ? "-" : new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value));
    const updateTotals = (container, income, expense, savings) => {
      const incomeNode = container.querySelector('[data-total-type="income"]');
      const expenseNode = container.querySelector('[data-total-type="expense"]');
      const savingsNode = container.querySelector('[data-total-type="savings"]');

      if (incomeNode) {
        incomeNode.textContent = incomeNode.textContent.includes('(in)')
          ? `+ (in) ${formatCurrency(income)}`
          : formatCurrency(income);
      }
      if (expenseNode) {
        expenseNode.textContent = expenseNode.textContent.includes('(out)')
          ? `- (out) ${formatCurrency(expense)}`
          : formatCurrency(expense);
      }
      if (savingsNode) {
        savingsNode.textContent = savingsNode.textContent.includes('savings')
          ? `savings ${formatCurrency(savings)}`
          : formatCurrency(savings);
      }
    };

    parentGroups.forEach((parentGroup) => {
      const childGroups = document.querySelectorAll(`tbody.${parentGroup.classList[0]}`);
      let hasVisibleTransactionsInParent = false;
      let parentIncomeTotal = 0;
      let parentExpenseTotal = 0;
      let parentSavingsTotal = 0;

      childGroups.forEach((childGroup) => {
        const rows = childGroup.querySelectorAll('tr.transaction-row');
        let hasVisibleTransactionsInChild = false;
        let incomeTotal = 0;
        let expenseTotal = 0;
        let savingsTotal = 0;

        rows.forEach((row) => {
          const description = row.querySelector('.transaction-description')?.textContent.toLowerCase();
          const amount = parseFloat(row.querySelector('.transaction-amount')?.textContent.replace(/[^0-9.-]+/g, ""));
          const transactionType = row.dataset.transactionType;

          if (description && description.includes(filter)) {
            row.style.display = '';
            hasVisibleTransactionsInChild = true;
            if (transactionType === "income") {
              incomeTotal += amount;
            } else if (transactionType === "expense") {
              expenseTotal += amount;
            } else if (transactionType === "savings") {
              savingsTotal += amount;
            }
          } else {
            row.style.display = 'none';
          }
        });

        parentIncomeTotal += incomeTotal;
        parentExpenseTotal += expenseTotal;
        parentSavingsTotal += savingsTotal;

        childGroup.querySelectorAll('[data-amount-totals]').forEach((container) => {
          updateTotals(container, incomeTotal, expenseTotal, savingsTotal);
        });

        // Hide or show the child + parent based on the visibility of transactions
        if (hasVisibleTransactionsInChild) {
          childGroup.style.display = '';
          hasVisibleTransactionsInParent = true;
        } else {
          childGroup.style.display = 'none';
        }
      });

      // Update the total amounts
      const parentTotalsContainers = parentGroup.querySelectorAll('[data-amount-totals]');
      parentTotalsContainers.forEach((container) => {
        updateTotals(container, parentIncomeTotal, parentExpenseTotal, parentSavingsTotal);
      });

      // Hide or show the parent based on the visibility of transactions
      if (hasVisibleTransactionsInParent) {
        parentGroup.style.display = '';
        hasVisibleTransactions = true;
      } else {
        parentGroup.style.display = 'none';
      }
    });

    // Show or hide the empty state based on the visibility of transactions
    const emptyState = document.getElementById('empty-state');
    if (hasVisibleTransactions) {
      emptyState.style.display = 'none';
    } else {
      emptyState.style.display = '';
    }
  }
</script>
